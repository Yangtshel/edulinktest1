<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>EduLink</title>
    <link rel="icon" type="image/png" href="https://i.imghippo.com/files/vgr8207c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Google+Sans:wght@400;500;700&display=swap');

        :root {
            --surface: #ffffff;
            --background: #ffffff;
            --on-surface: #0f0f0f;
            --text-secondary: #374151;
            --outline: #e5e7eb;
            --hover-bg: #f2f2f2;
            --primary: #065fd4
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--on-surface);
            overflow: hidden;
            overscroll-behavior-x: none
        }

        h1,
        h2,
        h3,
        .google-font {
            font-family: 'Google Sans', 'Inter', sans-serif
        }

        * {
            scrollbar-width: none;
            -ms-overflow-style: none
        }

        *::-webkit-scrollbar {
            width: 0;
            background: transparent;
            display: none
        }

        i[data-lucide],
        svg {
            flex-shrink: 0
        }

        .fade-in {
            animation: fadeUp .4s cubic-bezier(.2, 0, 0, 1) forwards;
            opacity: 0;
            transform: translateY(10px)
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .app-panel {
            background: var(--surface);
            border-radius: 0;
            border: none;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all .3s cubic-bezier(.2, 0, 0, 1)
        }

        @media (min-width:768px) {
            .app-panel {
                border-radius: 20px;
                border: 1px solid var(--outline);
                box-shadow: 0 1px 2px rgba(0, 0, 0, .03)
            }
        }

        @media (max-width:768px) {
            body {
                padding: 0 !important
            }

            #workspace-layout {
                gap: 0 !important
            }
        }

        #main-sidebar {
            width: 88px;
            flex-shrink: 0;
            padding: 24px 12px;
            transition: width .3s cubic-bezier(.2, 0, 0, 1), padding .3s ease
        }

        @media (min-width:1024px) {
            #main-sidebar {
                width: 260px;
                padding: 24px 20px
            }
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 15px;
            border-radius: 12px;
            transition: all .2s ease;
            cursor: pointer;
            text-decoration: none;
            margin-bottom: 4px;
            justify-content: center;
            position: relative
        }

        .nav-item:hover {
            color: var(--on-surface);
            background-color: var(--hover-bg)
        }

        .nav-item.active {
            color: var(--primary);
            background-color: #eff4ff;
            font-weight: 600
        }

        .nav-badge {
            position: absolute;
            top: 10px;
            right: 12px;
            background-color: #c00;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            height: 16px;
            min-width: 16px;
            padding: 0 4px;
            border-radius: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            z-index: 10
        }

        .mobile-footer-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: #c00;
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            height: 16px;
            min-width: 16px;
            padding: 0 4px;
            border-radius: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            border: 2px solid #fff;
            z-index: 20
        }

        @media (min-width:1024px) {
            .nav-item {
                justify-content: flex-start;
                padding: 10px 16px
            }

            .nav-badge {
                right: auto;
                left: 28px;
                top: 8px
            }
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: background-color .2s;
            justify-content: center
        }

        .sidebar-user:hover {
            background-color: var(--hover-bg)
        }

        @media (min-width:1024px) {
            .sidebar-user {
                justify-content: flex-start;
                padding: 8px 12px
            }
        }

        .create-btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            background: #1f1f1f;
            color: #fff;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            transition: all .2s ease;
            width: 100%;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, .1);
            line-height: 1;
            min-width: 0;
            white-space: nowrap
        }

        .create-btn:hover {
            background: #000;
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, .1)
        }

        .post-card {
            background: var(--surface);
            border-bottom: 1px solid var(--outline);
            border-radius: 0;
            transition: background-color .2s ease;
            margin-bottom: 0;
            box-shadow: none;
            overflow: visible
        }

        .post-card:hover {
            background-color: #fdfdfd;
            cursor: pointer;
            transform: none
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px
        }

        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--hover-bg);
            object-fit: cover;
            cursor: pointer;
        }

        .post-author-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--on-surface);
            line-height: 1.2
        }

        .post-author-name:hover {
            text-decoration: underline;
            color: var(--primary)
        }

        .post-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
            font-weight: 400
        }

        .post-body {
            font-size: 15px;
            line-height: 1.6;
            color: var(--on-surface);
            margin-bottom: 12px;
            white-space: pre-wrap
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 12px;
            padding-bottom: 4px
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 9999px;
            border: 1px solid var(--outline);
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            transition: all .2s;
            background: transparent;
            cursor: pointer;
            height: 34px;
            white-space: nowrap
        }

        .action-btn:hover {
            background-color: var(--hover-bg);
            border-color: #d1d5db
        }

        .action-btn.active {
            background-color: transparent;
            border-color: var(--outline)
        }

        .action-btn.like.active {
            color: var(--text-secondary);
            background-color: transparent;
            border-color: var(--outline)
        }

        .action-btn.like.active svg {
            fill: #ef4444;
            stroke: none;
            color: #ef4444
        }

        .action-btn.bookmark.active {
            color: var(--text-secondary);
            background-color: transparent;
            border-color: var(--outline)
        }

        .action-btn.bookmark.active svg {
            fill: #eab308;
            stroke: none;
            color: #eab308
        }

        .action-btn i,
        .action-btn svg {
            width: 18px;
            height: 18px
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: #0f0f0f;
            color: #f2f2f2;
            padding: 14px 28px;
            border-radius: 48px;
            font-size: 15px;
            opacity: 0;
            pointer-events: none;
            transition: all .3s;
            z-index: 200;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .15)
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0)
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background .2s;
            cursor: pointer;
            color: var(--on-surface)
        }

        .icon-btn:hover {
            background-color: var(--hover-bg)
        }

        #claim-link-overlay {
            position: fixed;
            inset: 0;
            z-index: 85;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s
        }

        #claim-link-overlay.show {
            opacity: 1;
            pointer-events: auto
        }

        .compose-textarea {
            width: 100%;
            min-height: 120px;
            font-size: 17px;
            line-height: 1.6;
            color: var(--on-surface);
            border: none;
            outline: none;
            resize: none;
            background: 0 0
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden p-0 md:p-3 gap-4 bg-white">

    <div id="toast" class="toast"><i id="toast-icon" data-lucide="check-circle-2"
            class="w-5 h-5 text-[#c4eed0]"></i><span id="toast-msg">Action Completed</span></div>

    <!-- Claim Link Overlay -->
    <div id="claim-link-overlay" onclick="if(event.target.id==='claim-link-overlay')closeClaimOverlay()">
        <div class="bg-white w-[90%] max-w-[400px] rounded-2xl shadow-xl p-6" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Add Claim Link</h3>
            <input type="url" id="claim-link-input" placeholder="https://example.com/product"
                class="w-full border-b border-gray-200 py-2 outline-none focus:border-blue-500 font-medium text-gray-900 mb-6">
            <div class="flex justify-end gap-3">
                <button onclick="closeClaimOverlay()"
                    class="px-4 py-2 text-gray-600 font-bold text-sm hover:bg-gray-100 rounded-lg">Cancel</button>
                <button onclick="saveClaimLink()"
                    class="px-4 py-2 bg-[#0b57d0] text-white font-bold text-sm rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <!-- Compose Modal -->
    <div id="compose-overlay"
        class="fixed inset-0 z-[55] flex items-end md:items-center justify-center bg-[#000]/40 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-200"
        onclick="closeCompose()">
        <div id="compose-modal"
            class="bg-white w-full h-full md:h-auto md:w-[95%] md:max-w-[620px] rounded-none md:rounded-[24px] shadow-2xl relative transform translate-y-full md:translate-y-0 md:scale-95 transition-transform duration-200 flex flex-col overflow-hidden"
            onclick="event.stopPropagation()">
            <div class="flex items-center justify-between h-16 px-4 border-b border-gray-100">
                <button onclick="closeCompose()"
                    class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200 transition-colors">
                    <i data-lucide="arrow-left" class="w-6 h-6 text-gray-700"></i>
                </button>
                <span class="text-lg font-bold text-gray-900">Create Post</span>
                <div class="w-10"></div>
            </div>
            <div class="flex-1 overflow-y-auto p-4">
                <div class="flex gap-3 mb-4 items-center">
                    <img id="compose-avatar" src=""
                        class="w-10 h-10 rounded-full border border-gray-100 bg-gray-50 object-cover">
                    <div>
                        <div id="compose-name" class="text-[15px] font-bold text-[#1f1f1f]">User</div>
                    </div>
                </div>
                <textarea id="compose-text" placeholder="What's on your mind?" class="compose-textarea"></textarea>
            </div>
            <div class="bg-white border-t border-gray-100 z-10">
                <div class="border-b border-gray-100">
                    <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-gray-50 transition-colors"
                        onclick="toggleComposeSettings()">
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2">
                            <i data-lucide="settings-2" class="w-4 h-4"></i> Post Settings
                        </span>
                        <i data-lucide="chevron-up" id="compose-settings-arrow"
                            class="w-4 h-4 text-gray-400 transition-transform"></i>
                    </div>
                    <div id="compose-settings-area" class="hidden px-4 pb-4 space-y-3 bg-gray-50/50">
                        <div class="flex items-center justify-between cursor-pointer p-2 hover:bg-gray-100 rounded-lg transition-colors"
                            onclick="openClaimOverlay()">
                            <div class="flex items-center gap-2 text-sm text-gray-700">
                                <i data-lucide="shopping-bag" class="w-4 h-4"></i> Add Claim Link
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="claim-status-indicator" class="text-xs font-bold text-gray-400">Off</span>
                                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-4">
                    <button onclick="createPost()"
                        class="w-full py-3 bg-[#0b57d0] text-white font-bold rounded-xl hover:bg-blue-700 transition-all">
                        Post
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Sidebar -->
    <aside id="main-sidebar" class="hidden md:flex app-panel">
        <div class="h-12 flex items-center gap-3 mb-6 px-2 cursor-pointer" onclick="switchView('feed')">
            <img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
            <h1 class="text-[20px] font-bold text-[#1f1f1f] hidden lg:block tracking-tight">EduLink</h1>
        </div>
        <button onclick="openCompose()" class="create-btn hidden lg:flex">
            <i data-lucide="plus" class="w-5 h-5"></i>
            <span>Create</span>
        </button>
        <nav class="flex-1 space-y-1">
            <a href="#" onclick="switchView('feed');return false;" id="nav-feed" class="nav-item active">
                <i data-lucide="home" class="w-5 h-5"></i>
                <span class="hidden lg:block">Home</span>
            </a>
            <a href="#" onclick="switchView('profile');return false;" id="nav-profile" class="nav-item">
                <i data-lucide="user" class="w-5 h-5"></i>
                <span class="hidden lg:block">Profile</span>
            </a>
        </nav>
        <div class="mt-auto pt-4 border-t border-gray-100 flex flex-col gap-2">
            <div class="sidebar-user group" onclick="switchView('profile')">
                <img id="sidebar-avatar" src=""
                    class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 shrink-0 object-cover">
                <div class="hidden lg:block">
                    <div id="sidebar-name"
                        class="text-sm font-bold text-[#1f1f1f] group-hover:text-blue-700 transition-colors truncate w-[140px]">
                        User</div>
                    <div class="text-xs text-[#667085]">View Profile</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div id="workspace-layout" class="flex-1 flex min-w-0 gap-4 relative overflow-hidden transition-all duration-300">
        <main id="main-panel" class="flex-1 app-panel min-w-0 relative">
            <header id="main-header"
                class="h-16 md:h-20 flex items-center justify-between px-4 md:px-6 shrink-0 z-20 absolute top-0 w-full bg-white/95 md:bg-white/90 backdrop-blur-md border-b border-[#f0f0f0] transition-transform duration-300">
                <div class="md:hidden flex items-center gap-3 cursor-pointer" onclick="switchView('feed')">
                    <img src="https://i.imghippo.com/files/fRGt5603uII.png" class="w-8 h-8 object-contain">
                    <h1 class="text-lg font-bold text-[#1f1f1f] tracking-tight">EduLink</h1>
                </div>
                <div class="flex-1"></div>
                <div class="flex items-center gap-3">
                    <img id="header-avatar" src=""
                        class="w-9 h-9 rounded-full bg-gray-100 border border-gray-200 cursor-pointer hover:ring-2 ring-offset-1 ring-blue-500 transition-all"
                        onclick="switchView('profile')">
                </div>
            </header>

            <div id="view-feed" class="flex-1 h-full overflow-y-auto no-scrollbar p-0 bg-white pt-16 md:pt-20">
                <div id="feed-container"></div>
            </div>

            <div id="view-profile" class="flex-1 h-full overflow-y-auto no-scrollbar hidden bg-white"></div>
        </main>
    </div>

    <!-- Mobile Bottom Nav -->
    <nav id="mobile-bottom-nav"
        class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-[#eaecf0] h-[64px] flex items-center justify-around z-50 pb-[env(safe-area-inset-bottom)] px-2 shadow-lg transition-transform duration-300">
        <div class="mobile-nav-item active" onclick="switchView('feed')">
            <i data-lucide="home"></i>
        </div>
        <div class="mobile-nav-item" onclick="openCompose()">
            <i data-lucide="plus-square"></i>
        </div>
        <div class="mobile-nav-item" onclick="switchView('profile')">
            <img id="mobile-avatar" src="" class="w-6 h-6 rounded-full border border-gray-200">
        </div>
    </nav>

    <style>
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex: 1;
            gap: 4px;
            color: #000;
            transition: all .2s;
            cursor: pointer;
            position: relative
        }

        .mobile-nav-item i {
            width: 32px;
            height: 32px;
            transition: all .2s
        }

        .mobile-nav-item.active {
            color: #000000
        }

        .mobile-nav-item.active i {
            transform: scale(1.05);
            fill: black;
            stroke-width: 2.5px
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJH79UQl0rc96Qug0DKLevO4ZI_sn8Kno",
            authDomain: "edulinki.firebaseapp.com",
            projectId: "edulinki",
            storageBucket: "edulinki.firebasestorage.app",
            messagingSenderId: "248886466474",
            appId: "1:248886466474:web:160043201a6b28bafbbdd3",
            measurementId: "G-MQBH12VL7N"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.auth = auth;
        window.db = db;

        let currentUser = null;
        let users = [];
        let posts = [];
        let savedPosts = [];
        window.currentClaimLink = null;

        const refreshIcons = () => window.lucide?.createIcons();

        const formatDate = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            if (isNaN(date.getTime())) return '';
            const now = new Date();
            const seconds = (now - date) / 1000;
            if (seconds < 60) return 'Now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return date.toLocaleDateString();
        };

        const formatContent = (text) => {
            if (!text) return '';
            return text.replace(/[&<>]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;' }[c]))
                .replace(/@(\w+)/g, '<span class="text-blue-600 font-bold">@$1</span>')
                .replace(/#(\w+)/g, '<span class="text-blue-600 font-bold">#$1</span>')
                .replace(/\n/g, '<br>');
        };

        window.showToast = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msgEl = document.getElementById('toast-msg');

            icon.setAttribute('data-lucide', isError ? 'alert-circle' : 'check-circle-2');
            icon.style.color = isError ? '#ff4444' : '#c4eed0';
            msgEl.innerText = msg;

            toast.classList.add('show');
            refreshIcons();

            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        window.toggleComposeSettings = () => {
            const area = document.getElementById('compose-settings-area');
            const arrow = document.getElementById('compose-settings-arrow');
            area.classList.toggle('hidden');
            arrow.style.transform = area.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
            refreshIcons();
        };

        window.openClaimOverlay = () => {
            const overlay = document.getElementById('claim-link-overlay');
            const input = document.getElementById('claim-link-input');
            input.value = window.currentClaimLink || '';
            overlay.classList.add('show');
        };

        window.closeClaimOverlay = () => {
            const overlay = document.getElementById('claim-link-overlay');
            overlay.classList.remove('show');
        };

        window.saveClaimLink = () => {
            const input = document.getElementById('claim-link-input');
            const url = input.value.trim();

            if (url && !url.startsWith('http://') && !url.startsWith('https://')) {
                showToast('Please enter a valid URL starting with http:// or https://', true);
                return;
            }

            window.currentClaimLink = url || null;

            const indicator = document.getElementById('claim-status-indicator');
            if (url) {
                indicator.innerText = 'On';
                indicator.classList.remove('text-gray-400');
                indicator.classList.add('text-green-600');
                showToast('Claim link added!');
            } else {
                indicator.innerText = 'Off';
                indicator.classList.remove('text-green-600');
                indicator.classList.add('text-gray-400');
                showToast('Claim link removed');
            }

            closeClaimOverlay();
        };

        window.openCompose = () => {
            const overlay = document.getElementById('compose-overlay');
            overlay.classList.remove('opacity-0', 'pointer-events-none');
            const modal = document.getElementById('compose-modal');
            modal.classList.remove('translate-y-full', 'scale-95');

            document.getElementById('compose-text').value = '';
            window.currentClaimLink = null;

            const indicator = document.getElementById('claim-status-indicator');
            indicator.innerText = 'Off';
            indicator.classList.remove('text-green-600');
            indicator.classList.add('text-gray-400');

            refreshIcons();
        };

        window.closeCompose = () => {
            const overlay = document.getElementById('compose-overlay');
            overlay.classList.add('opacity-0', 'pointer-events-none');
            const modal = document.getElementById('compose-modal');
            modal.classList.add('translate-y-full', 'scale-95');
        };

        window.createPost = async () => {
            const content = document.getElementById('compose-text').value.trim();

            if (!content) {
                showToast('Please write something!', true);
                return;
            }

            try {
                const postData = {
                    content: content,
                    authorId: currentUser.id,
                    timestamp: serverTimestamp(),
                    likes: [],
                    comments: []
                };

                if (window.currentClaimLink) {
                    postData.claimLink = window.currentClaimLink;
                }

                await addDoc(collection(db, "posts"), postData);

                showToast('Post created!');
                closeCompose();

                window.currentClaimLink = null;
            } catch (error) {
                console.error('Error creating post:', error);
                showToast('Failed to create post', true);
            }
        };

        window.toggleLike = async (postId) => {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            const isLiked = post.likes && post.likes.includes(currentUser.id);

            try {
                if (isLiked) {
                    await updateDoc(doc(db, "posts", postId), {
                        likes: arrayRemove(currentUser.id)
                    });
                } else {
                    await updateDoc(doc(db, "posts", postId), {
                        likes: arrayUnion(currentUser.id)
                    });
                }
            } catch (error) {
                console.error('Error toggling like:', error);
            }
        };

        window.toggleSave = async (postId) => {
            const isSaved = savedPosts.includes(postId);

            try {
                if (isSaved) {
                    await updateDoc(doc(db, "users", currentUser.id), {
                        saved: arrayRemove(postId)
                    });
                    showToast('Removed from saved');
                } else {
                    await updateDoc(doc(db, "users", currentUser.id), {
                        saved: arrayUnion(postId)
                    });
                    showToast('Saved!');
                }
            } catch (error) {
                console.error('Error toggling save:', error);
            }
        };

        window.switchView = (view) => {
            ['feed', 'profile'].forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if (el) el.classList.add('hidden');
            });

            const viewEl = document.getElementById(`view-${view}`);
            if (viewEl) viewEl.classList.remove('hidden');

            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(el => el.classList.remove('active'));

            const nav = document.getElementById(`nav-${view}`);
            if (nav) nav.classList.add('active');

            const mobileItems = document.querySelectorAll('.mobile-nav-item');
            if (view === 'feed') {
                mobileItems[0]?.classList.add('active');
                if (document.getElementById('feed-container').children.length === 0) {
                    renderFeed();
                }
            } else if (view === 'profile') {
                mobileItems[2]?.classList.add('active');
                renderProfile();
            }

            setTimeout(() => refreshIcons(), 10);
        };

        function createPostElement(post) {
            const author = users.find(u => u.id === post.authorId) || { name: 'Unknown', avatar: '', id: post.authorId };
            const div = document.createElement('article');
            div.className = "post-card group overflow-hidden fade-in";

            const isLiked = post.likes && post.likes.includes(currentUser.id);
            const isSaved = savedPosts.includes(post.id);

            const likeText = (post.likes?.length > 0) ? post.likes.length : 'Like';
            const commentText = (post.comments?.length > 0) ? post.comments.length : 'Comment';

            let rightActionBtn = '';
            if (post.claimLink) {
                rightActionBtn = `<button class="action-btn text-[#0b57d0] border-blue-100 bg-blue-50 hover:bg-blue-100" onclick="event.stopPropagation(); window.open('${post.claimLink}', '_blank')">
      <i data-lucide="shopping-bag" class="w-4 h-4"></i> Claim
    </button>`;
            } else {
                rightActionBtn = `<button class="action-btn bookmark ${isSaved ? 'active' : ''}" onclick="event.stopPropagation(); toggleSave('${post.id}')">
      <i data-lucide="bookmark"></i>
    </button>`;
            }

            div.innerHTML = `
    <div class="p-4 md:p-5">
      <div class="post-header">
        <div class="flex gap-3">
          <img src="${author.avatar}" class="post-avatar">
          <div>
            <div class="flex items-center">
              <span class="post-author-name">${author.name}</span>
            </div>
            <div class="post-meta flex items-center">${formatDate(post.timestamp)}</div>
          </div>
        </div>
      </div>
      <div class="post-content">
        <div class="post-body">${formatContent(post.content)}</div>
      </div>
      <div class="post-actions">
        <button class="action-btn like ${isLiked ? 'active' : ''}" onclick="event.stopPropagation(); toggleLike('${post.id}')">
          <i data-lucide="heart"></i> <span>${likeText}</span>
        </button>
        <button class="action-btn comment">
          <i data-lucide="message-circle"></i> <span>${commentText}</span>
        </button>
        <button class="action-btn share-btn">
          <i data-lucide="redo-2"></i> <span class="hidden sm:inline">Share</span>
        </button>
        <div class="flex-1"></div>
        ${rightActionBtn}
      </div>
    </div>
  `;

            return div;
        }

        function renderFeed() {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';

            const sortedPosts = [...posts].sort((a, b) => {
                const timeA = a.timestamp?.toDate?.() || new Date(0);
                const timeB = b.timestamp?.toDate?.() || new Date(0);
                return timeB - timeA;
            });

            if (sortedPosts.length === 0) {
                container.innerHTML = `
      <div class="flex flex-col items-center justify-center py-12 text-center">
        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400">
          <i data-lucide="pen-tool" class="w-8 h-8"></i>
        </div>
        <h3 class="text-gray-900 font-bold text-lg">Welcome to EduLink</h3>
        <p class="text-gray-500 text-sm mt-1 max-w-xs">Be the first to share something!</p>
      </div>
    `;
            } else {
                sortedPosts.forEach(post => {
                    container.appendChild(createPostElement(post));
                });
            }

            refreshIcons();
        }

        function renderProfile() {
            const container = document.getElementById('view-profile');

            if (!currentUser) return;

            const userPosts = posts.filter(p => p.authorId === currentUser.id);

            container.innerHTML = `
    <div class="p-4 md:p-6 pt-20 md:pt-6">
      <div class="max-w-2xl mx-auto">
        <div class="mb-6">
          <img src="${currentUser.avatar}" class="w-24 h-24 rounded-full border-4 border-white object-cover mb-4">
          <h2 class="text-2xl font-bold text-gray-900">${currentUser.name}</h2>
          <p class="text-gray-500">@${currentUser.username || 'user'}</p>
          <p class="text-gray-700 mt-2">${currentUser.bio || 'No bio yet'}</p>
        </div>
        
        <div class="border-t border-gray-200 pt-4">
          <h3 class="text-lg font-bold mb-4">Your Posts (${userPosts.length})</h3>
          <div class="space-y-4" id="profile-posts"></div>
        </div>
      </div>
    </div>
  `;

            const postsContainer = container.querySelector('#profile-posts');

            if (userPosts.length === 0) {
                postsContainer.innerHTML = '<div class="text-center text-gray-400 py-8">No posts yet</div>';
            } else {
                userPosts.forEach(post => {
                    postsContainer.appendChild(createPostElement(post));
                });
            }

            refreshIcons();
        }

        function initRealtimeListeners() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                refreshIcons();
            });

            onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snapshot) => {
                posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                if (!document.getElementById('view-feed').classList.contains('hidden')) {
                    renderFeed();
                }

                if (!document.getElementById('view-profile').classList.contains('hidden')) {
                    renderProfile();
                }

                setTimeout(refreshIcons, 5);
            });
        }

        function updateUserInterface() {
            if (!currentUser) return;

            document.getElementById('sidebar-name').innerText = currentUser.name;
            document.getElementById('sidebar-avatar').src = currentUser.avatar;
            document.getElementById('mobile-avatar').src = currentUser.avatar;
            document.getElementById('header-avatar').src = currentUser.avatar;
            document.getElementById('compose-name').innerText = currentUser.name;
            document.getElementById('compose-avatar').src = currentUser.avatar;

            refreshIcons();
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login';
                return;
            }

            const userDoc = doc(db, "users", user.uid);
            const snapshot = await getDoc(userDoc);

            if (snapshot.exists()) {
                currentUser = { id: user.uid, ...snapshot.data() };
            } else {
                const newUser = {
                    name: user.displayName || 'User',
                    email: user.email,
                    username: 'user' + user.uid.substring(0, 6).toLowerCase(),
                    avatar: user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'User'}&background=random`,
                    bio: 'Hello EduLink!',
                    following: [],
                    followers: [],
                    saved: [],
                    timestamp: serverTimestamp()
                };
                await setDoc(userDoc, newUser);
                currentUser = { id: user.uid, ...newUser };
            }

            currentUser.saved = currentUser.saved || [];
            savedPosts = currentUser.saved;
            window.currentUser = currentUser;

            updateUserInterface();
            initRealtimeListeners();
            renderFeed();
            refreshIcons();
        });

        refreshIcons();
    </script>

</body>

</html>
